<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer Citra + Upload/Download AOI</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 8px 10px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
    }
    .topbar input[type="file"] { display: none; }
    .btn {
      cursor: pointer; padding: 7px 12px; background: #2d6cdf; color: #fff;
      border-radius: 8px; border: 0; font-size: 14px;
    }
    .btn.secondary { background: #f0f0f0; color: #333; }
    .btn.danger { background: #e53935; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .small { font-size: 12px; color: #555; margin-left: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <label class="btn" for="geojsonInput">Upload GeoJSON</label>
    <input id="geojsonInput" type="file" accept=".geojson,application/geo+json,application/json" />
    <button id="clearBtn" class="btn secondary">Hapus penanda</button>
    <button id="dlAoiBtn" class="btn" disabled>Unduh AOI (.geojson)</button>
    <button id="dlBboxBtn" class="btn" disabled>Unduh BBOX (.geojson)</button>
    <button id="dlPngBtn" class="btn" style="display:none" disabled>Unduh Citra AOI (PNG)</button>
    <span class="small">Basemap: Esri World Imagery (ganti via kontrol kanan atas).</span>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Turf.js untuk bbox/centroid -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // OPSIONAL: isi API key MapTiler untuk enable "Unduh Citra AOI (PNG)"
    const maptilerKey = ''; // contoh: 'YOUR_MAPTILER_KEY'

    // Inisialisasi peta
    const map = L.map('map', { zoomControl: true }).setView([-2.5, 118], 5);

    // Basemap: Esri World Imagery (resolusi tinggi, relatif minim awan)
    const esriWorldImagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 20,
        attribution:
          'Imagery Â© Esri, Maxar, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and GIS User Community'
      }
    ).addTo(map);

    // Opsi lain: MapTiler Satellite (butuh API key)
    const maptilerSatellite = maptilerKey
      ? L.tileLayer(
          'https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=' + maptilerKey,
          { maxZoom: 20, attribution: '&copy; MapTiler &copy; OpenStreetMap contributors' }
        )
      : null;

    // Overlay: Sentinel-2 Cloudless (minim awan, 10m)
    const s2cloudless = L.tileLayer(
      'https://tiles.maps.eox.at/wmts?service=WMTS&request=GetTile&version=1.0.0&layer=s2cloudless-2020_3857&style=default&format=image/jpeg&tilematrixset=GoogleMapsCompatible&TileMatrix={z}&TileCol={x}&TileRow={y}',
      { maxZoom: 18, attribution: '&copy; Sentinel-2 cloudless by EOX & partners' }
    );

    const baseLayers = { 'Esri World Imagery (default)': esriWorldImagery };
    if (maptilerSatellite) baseLayers['MapTiler Satellite'] = maptilerSatellite;
    const overlays = { 'Sentinel-2 Cloudless (10 m)': s2cloudless };

    L.control.layers(baseLayers, overlays, { position: 'topright', collapsed: true }).addTo(map);

    // Layer untuk GeoJSON
    let geojsonLayer = null;

    const dom = {
      input: document.getElementById('geojsonInput'),
      clear: document.getElementById('clearBtn'),
      dlAoi: document.getElementById('dlAoiBtn'),
      dlBbox: document.getElementById('dlBboxBtn'),
      dlPng: document.getElementById('dlPngBtn')
    };

    if (maptilerKey) {
      dom.dlPng.style.display = 'inline-block';
    }

    function styleFeature() {
      return {
        color: '#ff5722',
        weight: 2,
        opacity: 0.9,
        fillColor: '#ff5722',
        fillOpacity: 0.2
      };
    }

    function onEachFeature(feature, layer) {
      const props = feature.properties || {};
      const rows = Object.entries(props)
        .map(([k, v]) => `<tr><td><b>${k}</b></td><td>${String(v)}</td></tr>`)
        .join('');
      const html = rows ? `<table>${rows}</table>` : 'Tidak ada atribut';
      layer.bindPopup(html);
    }

    function updateButtonsState() {
      const hasAOI = !!geojsonLayer;
      dom.dlAoi.disabled = !hasAOI;
      dom.dlBbox.disabled = !hasAOI;
      dom.dlPng.disabled = !hasAOI || !maptilerKey;
    }

    function flattenToFeatureCollection(input) {
      // Pastikan output FeatureCollection WGS84
      if (!input) return null;
      const fc = { type: 'FeatureCollection', features: [] };
      function addFeature(f) {
        if (!f) return;
        if (f.type === 'FeatureCollection') {
          f.features.forEach(addFeature);
        } else if (f.type === 'Feature') {
          fc.features.push(f);
        } else {
          // Geometry saja
          fc.features.push({ type: 'Feature', properties: {}, geometry: f });
        }
      }
      addFeature(input);
      return fc.features.length ? fc : null;
    }

    function getAOIFeatureCollection() {
      if (!geojsonLayer) return null;
      const parts = [];
      geojsonLayer.eachLayer(l => parts.push(l.toGeoJSON()));
      return flattenToFeatureCollection({ type: 'FeatureCollection', features: parts });
    }

    // Upload GeoJSON
    dom.input.addEventListener('change', async (ev) => {
      const file = ev.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (geojsonLayer) map.removeLayer(geojsonLayer);

        geojsonLayer = L.geoJSON(data, {
          style: styleFeature,
          pointToLayer: (feat, latlng) =>
            L.circleMarker(latlng, {
              radius: 6,
              color: '#ff5722',
              fillColor: '#ff5722',
              fillOpacity: 0.85
            }),
          onEachFeature
        }).addTo(map);

        // Zoom ke AOI
        try {
          const bounds = geojsonLayer.getBounds();
          if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
        } catch (e) {}
        updateButtonsState();
      } catch (err) {
        alert('Gagal membaca GeoJSON: ' + err.message);
      } finally {
        ev.target.value = '';
      }
    });

    // Hapus AOI
    dom.clear.addEventListener('click', () => {
      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
        geojsonLayer = null;
        updateButtonsState();
      }
    });

    // Download helper
    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    // Unduh AOI sebagai GeoJSON
    dom.dlAoi.addEventListener('click', () => {
      const fc = getAOIFeatureCollection();
      if (!fc) return alert('AOI belum ada.');
      downloadFile('aoi.geojson', JSON.stringify(fc, null, 2), 'application/geo+json');
    });

    // Unduh BBOX AOI sebagai GeoJSON Polygon
    dom.dlBbox.addEventListener('click', () => {
      const fc = getAOIFeatureCollection();
      if (!fc) return alert('AOI belum ada.');
      const bbox = turf.bbox(fc); // [minX,minY,maxX,maxY]
      const poly = turf.bboxPolygon(bbox);
      downloadFile('aoi_bbox.geojson', JSON.stringify(poly, null, 2), 'application/geo+json');
    });

    // Unduh citra AOI (PNG) via MapTiler Static API (opsional)
    dom.dlPng.addEventListener('click', async () => {
      const fc = getAOIFeatureCollection();
      if (!fc) return alert('AOI belum ada.');
      if (!maptilerKey) return alert('Isi maptilerKey untuk fitur ini.');

      const [minX, minY, maxX, maxY] = turf.bbox(fc);
      // Hitung ukuran gambar berdasar rasio bbox (sederhana, cukup untuk banyak kasus)
      const ratio = Math.max(0.000001, (maxX - minX) / Math.max(0.000001, (maxY - minY)));
      const maxDim = 2048; // batas aman untuk free plan
      let width, height;
      if (ratio >= 1) {
        width = maxDim;
        height = Math.max(256, Math.round(width / ratio));
      } else {
        height = maxDim;
        width = Math.max(256, Math.round(height * ratio));
      }

      const url = `https://api.maptiler.com/maps/satellite/static/bbox/${minX},${minY},${maxX},${maxY}/${width}x${height}.png?key=${maptilerKey}`;

      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Gagal mengambil citra: ' + resp.status);
        const blob = await resp.blob();
        downloadFile('aoi_satellite.png', await blob.arrayBuffer(), 'image/png');
      } catch (e) {
        alert('Gagal unduh citra AOI: ' + e.message + '\nPastikan area tidak terlalu besar & API key valid.');
      }
    });